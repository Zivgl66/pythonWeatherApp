#	Stages to start argocd on minikube
$ minikube start --cpus 4 --memory 8192  # Start minikube with more cpu and memory 
$ kubectl create namespace argocd
$ kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/v2.8.4/manifests/install.yaml
$ kubectl get all -n argocd
$ kubectl port-forward svc/argocd-server -n argocd 8080:443
$ kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d; echo


#	ArgoCD commands:
$ argocd login argocd.example.com --username admin --password yourpassword
$ argocd app list       /  $ kubectl get applications -n argocd



#	Create a new ArgoCD project from the CLI:
$ argocd login <ARGO-SERVER-URL>
$ argocd app create weatherk8s --repo https://github.com/Zivgl66/k8s-weatherapp --path ./ --dest-namespace default --dest-server https://kubernetes.default.svc --directory-recurse
application 'weatherk8s' created


# 	Create a new user:
$    kubectl edit configmap argocd-rbac-cm -n argocd	
#	Add this policy the configmap:
   data:	
     policy.csv: |
       p, role:readonly, applications, get, */*, allow
       p, role:readonly, logs, get, */*, allow
     policy.default: role:readonly
#	Add user and give it the roles:
   data:
     accounts.your-teammate: apiKey, login
#	Change the teammate's password:
   argocd account update-password --account your-teammate --current-password <current-admin-password> --new-password <new-teammate-password>



#	Helm command to install argocd on the eks cluster:
$ helm repo add argo https://argoproj.github.io/argo-helm
$ helm repo update
$ kubectl create namespace argocd
$ helm install argocd argo/argo-cd --namespace argocd
$ kubectl patch svc argocd-server -n argocd -p '{"spec": {"type": "LoadBalancer"}}'
$ pass=kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d; echo
$ 


apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: weatherapp
  namespace: argocd
spec:
  project: default

  source:
    repoURL: https://github.com/Zivgl66/k8s-weatherapp
    targetRevision: HEAD
    path: manifest
  destination:
    server: https://kubernetes.default.svc
    namespace: myapp
  syncPolicy:
   automated:
    prune: true
    selfHeal: true
